name: Deploy Integrated App (Frontend + Backend)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy-integrated.yml'
      - 'scripts/deploy-integrated-app.sh'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: gaitanalysisapp
  RESOURCE_GROUP: gait-analysis-rg-wus3
  ACR_NAME: gaitacr737
  IMAGE_NAME: gait-integrated
  IMAGE_TAG: latest
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Build frontend
      run: |
        echo "ğŸ“¦ Building frontend..."
        cd frontend
        npm ci
        npm run build
        echo "âœ… Frontend built"
        
    - name: Copy frontend to backend
      run: |
        echo "ğŸ“‹ Copying frontend build to backend..."
        rm -rf backend/frontend-dist
        cp -r frontend/dist backend/frontend-dist
        echo "âœ… Frontend copied to backend/frontend-dist"
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Log in to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Verify Azure resources exist
      run: |
        echo "ğŸ” Verifying Azure resources..."
        
        # Check Resource Group
        if ! az group show --name ${{ env.RESOURCE_GROUP }} &>/dev/null; then
          echo "âŒ Error: Resource group '${{ env.RESOURCE_GROUP }}' not found!"
          exit 1
        fi
        echo "âœ… Resource group exists"
        
        # Check App Service
        if ! az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
          echo "âŒ Error: App Service '${{ env.AZURE_WEBAPP_NAME }}' not found!"
          exit 1
        fi
        echo "âœ… App Service exists"
        
        # Check ACR
        if ! az acr show --name ${{ env.ACR_NAME }} &>/dev/null; then
          echo "âŒ Error: ACR '${{ env.ACR_NAME }}' not found!"
          exit 1
        fi
        echo "âœ… ACR exists"
        
        echo "âœ… All Azure resources verified"
        
    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.ACR_NAME }}
        
    - name: Verify Dockerfile exists
      run: |
        if [ ! -f "backend/Dockerfile.integrated" ]; then
          echo "âŒ Error: Dockerfile.integrated not found!"
          exit 1
        fi
        echo "âœ… Dockerfile.integrated found"
        
    - name: Verify frontend build exists
      run: |
        if [ ! -d "backend/frontend-dist" ]; then
          echo "âŒ Error: frontend-dist directory not found!"
          exit 1
        fi
        if [ ! -f "backend/frontend-dist/index.html" ]; then
          echo "âŒ Error: frontend-dist/index.html not found!"
          exit 1
        fi
        echo "âœ… Frontend build verified"
        
    - name: Verify cleaned code before build
      run: |
        echo "ğŸ” Verifying cleaned code structure..."
        cd backend
        
        # Verify old files are deleted
        if [ -f "app/api/v1/analysis.py" ]; then
          echo "âŒ Error: Old analysis.py still exists!"
          exit 1
        fi
        if [ -f "app/api/v1/health.py" ]; then
          echo "âŒ Error: Old health.py still exists!"
          exit 1
        fi
        if [ -f "app/api/v1/reports.py" ]; then
          echo "âŒ Error: Old reports.py still exists!"
          exit 1
        fi
        
        # Verify __init__.py doesn't import old files
        if grep -q "from app.api.v1 import analysis, health, reports" app/api/v1/__init__.py; then
          echo "âŒ Error: __init__.py still imports deleted files!"
          exit 1
        fi
        
        # Verify only Azure-native files exist
        echo "âœ… Verified: Only Azure-native files present"
        echo "   - analysis_azure.py exists"
        echo "   - Old files deleted"
        echo "   - __init__.py is clean"
        
    - name: Build and push Docker image to ACR
      run: |
        echo "ğŸ³ Building Docker image (Frontend + Backend)..."
        cd backend
        
        # Verify required files exist
        echo "ğŸ“‹ Verifying required files..."
        ls -la Dockerfile.integrated || exit 1
        ls -la frontend-dist/index.html || exit 1
        ls -la main_integrated.py || exit 1
        
        # Build image using ACR Tasks (force rebuild with --no-cache)
        echo "ğŸ”¨ Starting Docker build (no cache to ensure clean build)..."
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
          --file Dockerfile.integrated \
          . \
          --no-cache \
          --no-logs || exit 1
          
        echo "âœ… Docker image built and pushed to ACR"
        
    - name: Get ACR credentials
      id: acr-creds
      run: |
        ACR_LOGIN=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer -o tsv)
        ACR_USER=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
        ACR_PASS=$(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value -o tsv)
        
        echo "login_server=$ACR_LOGIN" >> $GITHUB_OUTPUT
        echo "username=$ACR_USER" >> $GITHUB_OUTPUT
        echo "password=$ACR_PASS" >> $GITHUB_OUTPUT
        
    - name: Configure App Service container
      run: |
        echo "âš™ï¸  Configuring App Service container..."
        az webapp config container set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --docker-custom-image-name "${{ steps.acr-creds.outputs.login_server }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          --docker-registry-server-url "https://${{ steps.acr-creds.outputs.login_server }}" \
          --docker-registry-server-user "${{ steps.acr-creds.outputs.username }}" \
          --docker-registry-server-password "${{ steps.acr-creds.outputs.password }}" \
          --output none
          
        # Also set password via app settings (backup method)
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --settings DOCKER_REGISTRY_SERVER_PASSWORD="${{ steps.acr-creds.outputs.password }}" \
          --output none
          
        echo "âœ… Container configuration updated"
        
    - name: Configure App Service settings
      run: |
        echo "âš™ï¸  Configuring App Service settings..."
        
        # Get Azure service credentials
        STORAGE_ACCOUNT=$(az storage account list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?contains(name, 'gait')].name" -o tsv | head -1)
        CV_NAME=$(az cognitiveservices account list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?kind=='ComputerVision'].name" -o tsv | head -1)
        SQL_SERVER=$(az sql server list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?contains(name, 'gait')].name" -o tsv | head -1)
        
        if [ -n "$STORAGE_ACCOUNT" ] && [ -n "$CV_NAME" ] && [ -n "$SQL_SERVER" ]; then
          STORAGE_CONN=$(az storage account show-connection-string --name "$STORAGE_ACCOUNT" --resource-group ${{ env.RESOURCE_GROUP }} --query connectionString -o tsv)
          CV_KEY=$(az cognitiveservices account keys list --name "$CV_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query key1 -o tsv)
          CV_ENDPOINT=$(az cognitiveservices account show --name "$CV_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query properties.endpoint -o tsv)
          
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings \
              WEBSITES_PORT=8000 \
              CORS_ORIGINS="https://gentle-sky-0a498ab1e.4.azurestaticapps.net,https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net,http://localhost:3000,http://localhost:5173" \
              AZURE_STORAGE_CONNECTION_STRING="$STORAGE_CONN" \
              AZURE_STORAGE_CONTAINER_NAME="videos" \
              AZURE_COMPUTER_VISION_KEY="$CV_KEY" \
              AZURE_COMPUTER_VISION_ENDPOINT="$CV_ENDPOINT" \
              AZURE_SQL_SERVER="$SQL_SERVER.database.windows.net" \
              AZURE_SQL_DATABASE="gaitanalysis" \
              AZURE_SQL_USER="gaitadmin" \
              AZURE_SQL_PASSWORD="${{ secrets.AZURE_SQL_PASSWORD }}" \
            --output none
        else
          # Set basic settings even if services don't exist
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings \
              WEBSITES_PORT=8000 \
              CORS_ORIGINS="https://gentle-sky-0a498ab1e.4.azurestaticapps.net,https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net,http://localhost:3000,http://localhost:5173" \
            --output none
        fi
        
        # Enable Always-On
        az webapp config set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --always-on true \
          --output none
          
        echo "âœ… App Service settings configured"
        
    - name: Restart App Service
      run: |
        echo "ğŸ”„ Restarting App Service..."
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --output none
        echo "âœ… App Service restarted"
        
    - name: Wait for deployment
      run: |
        echo "â³ Waiting 90 seconds for container to start..."
        sleep 90
        
    - name: Health check
      run: |
        echo "ğŸ§ª Testing application health..."
        APP_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        
        echo "ğŸ“ Testing endpoints:"
        echo "   - $APP_URL/"
        echo "   - $APP_URL/health"
        echo ""
        
        for i in {1..20}; do
          # Test root endpoint
          HTTP_CODE_ROOT=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$APP_URL/" || echo "000")
          # Test health endpoint
          HTTP_CODE_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$APP_URL/health" || echo "000")
          
          if [ "$HTTP_CODE_ROOT" = "200" ] || [ "$HTTP_CODE_HEALTH" = "200" ]; then
            echo ""
            echo "âœ…âœ…âœ… Application is healthy!"
            echo "   Root endpoint: HTTP $HTTP_CODE_ROOT"
            echo "   Health endpoint: HTTP $HTTP_CODE_HEALTH"
            echo ""
            
            # Show health check details
            curl -s --max-time 10 "$APP_URL/health" | python3 -m json.tool 2>/dev/null || \
            curl -s --max-time 10 "$APP_URL/" | python3 -m json.tool 2>/dev/null || \
            echo "   (Response received but not JSON)"
            
            echo ""
            echo "ğŸ”— Application URL: $APP_URL"
            echo "âœ… Integrated deployment successful!"
            exit 0
          else
            echo "   Check $i/20... (Root: $HTTP_CODE_ROOT, Health: $HTTP_CODE_HEALTH)"
            if [ "$i" -eq 10 ]; then
              echo "   â³ Still starting... checking logs might help"
            fi
            sleep 10
          fi
        done
        
        echo ""
        echo "âš ï¸  Application health check failed or still starting"
        echo "   Final status: Root=$HTTP_CODE_ROOT, Health=$HTTP_CODE_HEALTH"
        echo "   Check Azure Portal logs for details:"
        echo "   https://portal.azure.com/#@/resource/subscriptions/*/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ env.AZURE_WEBAPP_NAME }}/logStream"
        echo ""
        echo "   You can also check logs with:"
        echo "   az webapp log tail --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}"
        exit 1

    - name: Deployment summary
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š DEPLOYMENT SUMMARY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ”— Application URL:"
        echo "   https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo ""
        echo "ğŸ“¦ Docker Image:"
        echo "   ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
        echo ""
        echo "ğŸ” Azure Resources:"
        echo "   Resource Group: ${{ env.RESOURCE_GROUP }}"
        echo "   App Service: ${{ env.AZURE_WEBAPP_NAME }}"
        echo "   ACR: ${{ env.ACR_NAME }}"
        echo ""
        echo "ğŸ“ Useful Commands:"
        echo "   View logs: az webapp log tail --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}"
        echo "   Check status: az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query state"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""


