name: Deploy Backend to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: gaitanalysisapp
  RESOURCE_GROUP: gait-analysis-rg-wus3
  ACR_NAME: gaitacr737
  IMAGE_NAME: gait-integrated
  IMAGE_TAG: latest
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Log in to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.ACR_NAME }}
        
    - name: Build and push Docker image to ACR
      run: |
        echo "üê≥ Building Docker image..."
        cd backend
        
        # Build image using ACR Tasks
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
          --file Dockerfile.integrated \
          .
          
        echo "‚úÖ Docker image built and pushed to ACR"
        
    - name: Get ACR credentials
      id: acr-creds
      run: |
        ACR_LOGIN=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer -o tsv)
        ACR_USER=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
        ACR_PASS=$(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value -o tsv)
        
        echo "login_server=$ACR_LOGIN" >> $GITHUB_OUTPUT
        echo "username=$ACR_USER" >> $GITHUB_OUTPUT
        echo "password=$ACR_PASS" >> $GITHUB_OUTPUT
        
    - name: Configure App Service container
      run: |
        echo "‚öôÔ∏è  Configuring App Service container..."
        az webapp config container set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --docker-custom-image-name "${{ steps.acr-creds.outputs.login_server }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          --docker-registry-server-url "https://${{ steps.acr-creds.outputs.login_server }}" \
          --docker-registry-server-user "${{ steps.acr-creds.outputs.username }}" \
          --docker-registry-server-password "${{ steps.acr-creds.outputs.password }}" \
          --output none
          
        # Also set password via app settings (backup method)
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --settings DOCKER_REGISTRY_SERVER_PASSWORD="${{ steps.acr-creds.outputs.password }}" \
          --output none
          
        echo "‚úÖ Container configuration updated"
        
    - name: Configure App Service settings
      run: |
        echo "‚öôÔ∏è  Configuring App Service settings..."
        
        # Get Azure service credentials
        STORAGE_ACCOUNT=$(az storage account list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?contains(name, 'gait')].name" -o tsv | head -1)
        CV_NAME=$(az cognitiveservices account list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?kind=='ComputerVision'].name" -o tsv | head -1)
        SQL_SERVER=$(az sql server list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?contains(name, 'gait')].name" -o tsv | head -1)
        
        if [ -n "$STORAGE_ACCOUNT" ] && [ -n "$CV_NAME" ] && [ -n "$SQL_SERVER" ]; then
          STORAGE_CONN=$(az storage account show-connection-string --name "$STORAGE_ACCOUNT" --resource-group ${{ env.RESOURCE_GROUP }} --query connectionString -o tsv)
          CV_KEY=$(az cognitiveservices account keys list --name "$CV_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query key1 -o tsv)
          CV_ENDPOINT=$(az cognitiveservices account show --name "$CV_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query properties.endpoint -o tsv)
          
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings \
              WEBSITES_PORT=8000 \
              CORS_ORIGINS="https://gentle-sky-0a498ab1e.4.azurestaticapps.net,https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net,http://localhost:3000,http://localhost:5173" \
              AZURE_STORAGE_CONNECTION_STRING="$STORAGE_CONN" \
              AZURE_STORAGE_CONTAINER_NAME="videos" \
              AZURE_COMPUTER_VISION_KEY="$CV_KEY" \
              AZURE_COMPUTER_VISION_ENDPOINT="$CV_ENDPOINT" \
              AZURE_SQL_SERVER="$SQL_SERVER.database.windows.net" \
              AZURE_SQL_DATABASE="gaitanalysis" \
              AZURE_SQL_USER="gaitadmin" \
              AZURE_SQL_PASSWORD="${{ secrets.AZURE_SQL_PASSWORD }}" \
            --output none
        else
          # Set basic settings even if services don't exist
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings \
              WEBSITES_PORT=8000 \
              CORS_ORIGINS="https://gentle-sky-0a498ab1e.4.azurestaticapps.net,https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net,http://localhost:3000,http://localhost:5173" \
            --output none
        fi
        
        # Enable Always-On
        az webapp config set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --always-on true \
          --output none
          
        echo "‚úÖ App Service settings configured"
        
    - name: Restart App Service
      run: |
        echo "üîÑ Restarting App Service..."
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --output none
        echo "‚úÖ App Service restarted"
        
    - name: Wait for deployment
      run: |
        echo "‚è≥ Waiting 60 seconds for container to start..."
        sleep 60
        
    - name: Health check
      run: |
        echo "üß™ Testing application health..."
        APP_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        
        for i in {1..10}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$APP_URL/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ‚úÖ‚úÖ Application is healthy! (HTTP $HTTP_CODE)"
            curl -s --max-time 10 "$APP_URL/health" | python3 -m json.tool || true
            exit 0
          else
            echo "   Check $i/10... (HTTP $HTTP_CODE)"
            sleep 10
          fi
        done
        
        echo "‚ö†Ô∏è  Application health check failed or still starting"
        echo "   Check Azure Portal logs for details"
        exit 1


